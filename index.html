<?php
session_start();

// ----------------------
// Configurări de bază
// ----------------------

// Pentru simplitate, produsele sunt stocate într-un array asociativ.
// Fiecare produs are: id, nume, preț, cale imagine, descriere.
$products = [
    1 => [
        'name' => 'Lumânare Roșie',
        'price' => 10.00,
        'image' => 'images/lumânare_rosie.jpg',
        'description' => 'Lumânare din ceară naturală, ideală pentru rugăciuni și momente de liniște.'
    ],
    2 => [
        'name' => 'Icoană Sfântă',
        'price' => 25.50,
        'image' => 'images/icoana_sfanta.jpg',
        'description' => 'Icoană lucrată manual, un simbol al credinței.'
    ],
    3 => [
        'name' => 'Carte de Rugăciuni',
        'price' => 15.75,
        'image' => 'images/carte_rugaciuni.jpg',
        'description' => 'Carte cu rugăciuni și imnuri bisericești tradiționale.'
    ],
    // ... completează până la 20 produse
];

// Pentru zona de comenzi, stocăm comenzile în sesiune (în practică – într-o bază de date)
if (!isset($_SESSION['orders'])) {
    $_SESSION['orders'] = [];
}

// Pentru coșul de cumpărături, folosim sesiunea
if (!isset($_SESSION['cart'])) {
    $_SESSION['cart'] = [];
}

// ----------------------
// Funcții Ajutătoare
// ----------------------

// Randează header-ul comun (cu logo, meniu și timer)
function renderHeader() {
    ?>
    <!DOCTYPE html>
    <html lang="ro">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Magazin Bisericesc</title>
      <!-- Bootstrap CDN pentru design modern -->
      <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
      <style>
        body { background-color: #fff; }
        header { background-color: #000; color: #fff; padding: 10px 20px; }
        .navbar-brand { font-weight: bold; color: #e60000; }
        .nav-link { color: #fff; margin: 0 10px; }
        .timer { font-size: 1rem; color: #e60000; }
        .cart-icon {
            position: relative;
            cursor: pointer;
        }
        .cart-icon .badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background: red;
            color: #fff;
            border-radius: 50%;
        }
      </style>
    </head>
    <body>
      <header class="d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
          <img src="images/logo.png" alt="Logo" style="height:50px; margin-right:10px;">
          <span class="navbar-brand">Numele Firmei</span>
        </div>
        <nav>
          <ul class="nav">
            <li class="nav-item"><a class="nav-link" href="?page=home">Acasă</a></li>
            <li class="nav-item"><a class="nav-link" href="?page=produse">Produsele noastre</a></li>
            <li class="nav-item"><a class="nav-link" href="?page=despre">Despre noi</a></li>
            <li class="nav-item"><a class="nav-link" href="?page=termeni">Termeni și condiții</a></li>
            <li class="nav-item"><a class="nav-link" href="?page=calendar">Calendar</a></li>
            <li class="nav-item"><a class="nav-link" href="?page=admin">Admin</a></li>
            <li class="nav-item">
              <a class="nav-link cart-icon" href="?page=cos">
                <img src="images/cos.png" alt="Coș" style="height:24px;">
                <span class="badge"><?php echo array_sum($_SESSION['cart']); ?></span>
              </a>
            </li>
          </ul>
        </nav>
      </header>
      <!-- Timer pentru Paști -->
      <div class="text-center py-2 bg-light">
        <span id="timer" class="timer"></span>
      </div>
      <script>
        // Setează data Paștilor (exemplu: 20 aprilie 2025)
        let easterDate = new Date("2025-04-20T00:00:00").getTime();
        // Actualizează timer-ul la fiecare secundă
        let timerInterval = setInterval(function() {
          let now = new Date().getTime();
          let distance = easterDate - now;
          // Calcul pentru zile, ore, minute, secunde
          let days = Math.floor(distance / (1000 * 60 * 60 * 24));
          let hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
          let minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
          let seconds = Math.floor((distance % (1000 * 60)) / 1000);
  
          if (distance >= 0) {
            document.getElementById("timer").innerHTML = "Timp până la Paști: " + days + "z " + hours + "h " + minutes + "m " + seconds + "s ";
          } else {
            // După trecerea timpului, afişează mesajul dorit pentru 3 zile, apoi pentru următoarea sărbătoare majoră
            document.getElementById("timer").innerHTML = "Sărbătoarea a început! Următoarea mare sărbătoare se anunță în curând.";
            clearInterval(timerInterval);
          }
        }, 1000);
      </script>
    <?php
}

// Footer-ul comun
function renderFooter() {
    ?>
      <footer class="bg-dark text-white text-center p-3 mt-5">
        <p>&copy; <?php echo date("Y"); ?> Magazin Bisericesc. Toate drepturile rezervate.</p>
        <img src="images/logo_anpc.png" alt="Logo ANPC" style="height:30px;">
      </footer>
      <!-- Bootstrap JS -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </body>
    </html>
    <?php
}

// ----------------------
// Funcții pentru diferite pagini
// ----------------------

// Pagina de start: un background atractiv (sau carousel) și un buton către Produse
function renderHome() {
    ?>
    <div class="container mt-4">
      <div class="jumbotron p-5 text-center bg-secondary text-white" style="background-image: url('images/background_home.jpg'); background-size: cover;">
        <h1 class="display-4">Bine ați venit la Magazinul Bisericesc</h1>
        <p class="lead">Descoperă produsele noastre de calitate pentru momente de spiritualitate.</p>
        <a href="?page=produse" class="btn btn-danger btn-lg">Produsele noastre</a>
      </div>
    </div>
    <?php
}

// Pagina cu listă de produse
function renderProduse($products) {
    ?>
    <div class="container mt-4">
      <h2 class="mb-4">Produsele noastre</h2>
      <div class="row">
        <?php foreach ($products as $id => $prod): ?>
          <div class="col-md-4 mb-4">
            <div class="card h-100">
              <a href="?page=produs&id=<?php echo $id; ?>" style="text-decoration:none; color:inherit;">
                <img src="<?php echo $prod['image']; ?>" class="card-img-top" alt="<?php echo htmlspecialchars($prod['name']); ?>">
                <div class="card-body">
                  <h5 class="card-title"><?php echo htmlspecialchars($prod['name']); ?></h5>
                </div>
              </a>
              <div class="card-footer">
                <form method="post" action="">
                  <input type="hidden" name="action" value="add_to_cart">
                  <input type="hidden" name="prod_id" value="<?php echo $id; ?>">
                  <div class="input-group">
                    <input type="number" name="quantity" value="1" min="1" class="form-control" style="max-width: 70px;">
                    <button type="submit" class="btn btn-danger">Adaugă în coș</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        <?php endforeach; ?>
      </div>
    </div>
    <?php
}

// Pagina detaliu produs (afișează și câteva detalii suplimentare)
function renderProdus($products, $id) {
    if (!isset($products[$id])) {
        echo "<div class='container mt-4'><h3>Produsul nu există.</h3></div>";
        return;
    }
    $prod = $products[$id];
    ?>
    <div class="container mt-4">
      <div class="row">
        <div class="col-md-6">
          <img src="<?php echo $prod['image']; ?>" class="img-fluid" alt="<?php echo htmlspecialchars($prod['name']); ?>">
        </div>
        <div class="col-md-6">
          <h2><?php echo htmlspecialchars($prod['name']); ?></h2>
          <p><?php echo $prod['description']; ?></p>
          <p><strong>Preț:</strong> <?php echo number_format($prod['price'], 2); ?> Lei</p>
          <form method="post" action="">
              <input type="hidden" name="action" value="add_to_cart">
              <input type="hidden" name="prod_id" value="<?php echo $id; ?>">
              <div class="input-group mb-3" style="max-width:120px;">
                <input type="number" name="quantity" value="1" min="1" class="form-control">
                <button type="submit" class="btn btn-danger">Adaugă</button>
              </div>
          </form>
        </div>
      </div>
    </div>
    <?php
}

// Pagina Despre noi
function renderDespre() {
    ?>
    <div class="container mt-4">
      <h2>Despre Noi</h2>
      <p>Acest magazin oferă o gamă variată de produse bisericești: lumânări, cărți, icoane, tămâie și multe altele. Ne mândrim cu calitatea produselor și respectarea tradițiilor.</p>
    </div>
    <?php
}

// Pagina Termeni și condiții
function renderTermeni() {
    ?>
    <div class="container mt-4">
      <h2>Termeni și Condiții</h2>
      <p>Aici vor fi detaliate regulile și condițiile de vânzare, politica de returnare, drepturile consumatorilor etc.</p>
    </div>
    <?php
}

// Pagina Calendar (exemplu pentru luna aprilie – simplificat)
function renderCalendar() {
    ?>
    <div class="container mt-4">
      <h2>Calendar Creștin Ortodox – Aprilie</h2>
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Ziua</th>
            <th>Sărbătoare</th>
          </tr>
        </thead>
        <tbody>
          <?php for ($day = 1; $day <= 30; $day++): ?>
            <tr>
              <td><?php echo $day; ?></td>
              <td>
                <?php
                  // Exemplu de sărbătoare: poți completa după necesități
                  if ($day == 1) echo "Intrarea în Post";
                  elseif ($day == 14) echo "Sfântul Vasile";
                  else echo "-";
                ?>
              </td>
            </tr>
          <?php endfor; ?>
        </tbody>
      </table>
    </div>
    <?php
}

// Pagina Coș: afișează produsele selectate, posibilitatea de modificare a cantității și finalizare comenzii
function renderCos() {
    ?>
    <div class="container mt-4">
      <h2>Coșul de Cumpărături</h2>
      <?php if (empty($_SESSION['cart'])): ?>
        <p>Coșul este gol.</p>
      <?php else: ?>
        <table class="table">
          <thead>
            <tr>
              <th>Produs</th>
              <th>Cantitate</th>
              <th>Preț Unitar</th>
              <th>Total</th>
              <th>Acțiune</th>
            </tr>
          </thead>
          <tbody>
            <?php 
            $grandTotal = 0;
            foreach ($_SESSION['cart'] as $prod_id => $qty):
              global $products;
              if (!isset($products[$prod_id])) continue;
              $prod = $products[$prod_id];
              $total = $prod['price'] * $qty;
              $grandTotal += $total;
            ?>
              <tr>
                <td><?php echo htmlspecialchars($prod['name']); ?></td>
                <td><?php echo $qty; ?></td>
                <td><?php echo number_format($prod['price'], 2); ?> Lei</td>
                <td><?php echo number_format($total, 2); ?> Lei</td>
                <td>
                  <form method="post" action="" style="display:inline;">
                    <input type="hidden" name="action" value="remove_from_cart">
                    <input type="hidden" name="prod_id" value="<?php echo $prod_id; ?>">
                    <button type="submit" class="btn btn-sm btn-warning">Șterge</button>
                  </form>
                </td>
              </tr>
            <?php endforeach; ?>
            <tr>
              <td colspan="3" class="text-end"><strong>Total General:</strong></td>
              <td colspan="2"><strong><?php echo number_format($grandTotal,2); ?> Lei</strong></td>
            </tr>
          </tbody>
        </table>
        <!-- Formular de finalizare comanda -->
        <h4>Date de contact</h4>
        <form method="post" action="">
          <input type="hidden" name="action" value="place_order">
          <div class="mb-3">
            <label>Nume:</label>
            <input type="text" name="customer_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label>Email/Telefon:</label>
            <input type="text" name="customer_contact" class="form-control" required>
          </div>
          <button type="submit" class="btn btn-success">Finalizează comanda</button>
        </form>
      <?php endif; ?>
    </div>
    <?php
}

// Pagina Admin (autentificare simplă și dashboard)
function renderAdmin($products) {
    // Date hardcodate pentru autentificare admin
    $adminUser = 'admin';
    $adminPass = 'parola123';

    // Verificare login (simplu, fără criptare – doar exemplificare)
    if (isset($_POST['action']) && $_POST['action'] == 'admin_login') {
        $username = $_POST['username'] ?? '';
        $password = $_POST['password'] ?? '';
        if ($username === $adminUser && $password === $adminPass) {
            $_SESSION['admin'] = true;
        } else {
            echo "<div class='alert alert-danger'>Autentificare eșuată!</div>";
        }
    }
    
    // Dacă nu suntem autentificați, afișăm formularul de login
    if (!isset($_SESSION['admin']) || $_SESSION['admin'] !== true) {
        ?>
        <div class="container mt-4">
          <h2>Login Admin</h2>
          <form method="post" action="">
            <input type="hidden" name="action" value="admin_login">
            <div class="mb-3">
              <label>Utilizator:</label>
              <input type="text" name="username" class="form-control" required>
            </div>
            <div class="mb-3">
              <label>Parolă:</label>
              <input type="password" name="password" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Login</button>
          </form>
        </div>
        <?php
        return;
    }

    // Dashboard Admin
    ?>
    <div class="container mt-4">
      <h2>Panou Admin</h2>
      
      <!-- Secțiunea: Comenzi primite -->
      <h4>Comenzi Plasate</h4>
      <?php if (empty($_SESSION['orders'])): ?>
        <p>Nu există comenzi până în acest moment.</p>
      <?php else: ?>
        <table class="table">
          <thead>
            <tr>
              <th>ID Comandă</th>
              <th>Date client</th>
              <th>Produse</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            <?php foreach ($_SESSION['orders'] as $orderId => $order): ?>
            <tr>
              <td><?php echo $orderId; ?></td>
              <td><?php echo htmlspecialchars($order['customer_name']) . "<br>" . htmlspecialchars($order['customer_contact']); ?></td>
              <td>
                <?php 
                  foreach ($order['items'] as $prod_id => $qty) {
                      echo htmlspecialchars($products[$prod_id]['name']) . " x " . $qty . "<br>";
                  }
                ?>
              </td>
              <td><?php echo number_format($order['total'], 2); ?> Lei</td>
            </tr>
            <?php endforeach; ?>
          </tbody>
        </table>
      <?php endif; ?>

      <!-- Secțiunea: Actualizare stocuri (exemplu simplificat) -->
      <h4>Actualizare Stocuri</h4>
      <p>(Exemplu: aici se pot implementa funcționalități AJAX pentru actualizare dinamică.)</p>
      <a href="?page=logout_admin" class="btn btn-secondary">Logout Admin</a>
    </div>
    <?php
}

// ----------------------
// Procesarea cererilor POST
// ----------------------
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    // Adăugare produs în coș
    if (isset($_POST['action']) && $_POST['action'] == 'add_to_cart') {
        $prod_id = intval($_POST['prod_id']);
        $quantity = intval($_POST['quantity']);
        if (isset($_SESSION['cart'][$prod_id])) {
            $_SESSION['cart'][$prod_id] += $quantity;
        } else {
            $_SESSION['cart'][$prod_id] = $quantity;
        }
        // Redirect pentru a preveni resubmissionul formularului
        header("Location: " . $_SERVER['REQUEST_URI']);
        exit();
    }
    // Ștergere produs din coș
    if (isset($_POST['action']) && $_POST['action'] == 'remove_from_cart') {
        $prod_id = intval($_POST['prod_id']);
        if (isset($_SESSION['cart'][$prod_id])) {
            unset($_SESSION['cart'][$prod_id]);
        }
        header("Location: " . $_SERVER['REQUEST_URI']);
        exit();
    }
    // Finalizare comandă
    if (isset($_POST['action']) && $_POST['action'] == 'place_order') {
        $customerName = trim($_POST['customer_name']);
        $customerContact = trim($_POST['customer_contact']);
        if (!empty($_SESSION['cart']) && $customerName && $customerContact) {
            $orderTotal = 0;
            foreach ($_SESSION['cart'] as $prod_id => $qty) {
                global $products;
                $orderTotal += $products[$prod_id]['price'] * $qty;
            }
            $orderId = time(); // identificator simplificat
            $_SESSION['orders'][$orderId] = [
                'customer_name' => $customerName,
                'customer_contact' => $customerContact,
                'items' => $_SESSION['cart'],
                'total' => $orderTotal
            ];
            // Golește coșul după plasarea comenzii
            $_SESSION['cart'] = [];
            // Redirect la pagina principală
            header("Location: ?page=home");
            exit();
        }
    }
}

// ----------------------
// Routing: selectarea paginii în funcție de parametrul "page"
// ----------------------
$page = isset($_GET['page']) ? $_GET['page'] : 'home';

// Pentru logout-ul admin (exemplu simplificat)
if ($page == 'logout_admin') {
    unset($_SESSION['admin']);
    header("Location: ?page=admin");
    exit();
}

// Randează header-ul
renderHeader();

// În funcție de pagina selectată se afișează conținutul:
switch ($page) {
    case 'home':
        renderHome();
        break;
    case 'produse':
        renderProduse($products);
        break;
    case 'produs':
        // Se așteaptă parametrul id al produsului
        $id = isset($_GET['id']) ? intval($_GET['id']) : 0;
        renderProdus($products, $id);
        break;
    case 'despre':
        renderDespre();
        break;
    case 'termeni':
        renderTermeni();
        break;
    case 'calendar':
        renderCalendar();
        break;
    case 'cos':
        renderCos();
        break;
    case 'admin':
        renderAdmin($products);
        break;
    default:
        echo "<div class='container mt-4'><h3>Pagina cerută nu există!</h3></div>";
        break;
}

// Randează footer-ul comun
renderFooter();
?>
